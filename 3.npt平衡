# 1.é…ç½®ç¯å¢ƒ
# å®‰è£…ä¾èµ–ï¼ˆCUDA + CMake + ç¼–è¯‘å·¥å…·ï¼‰
!apt-get update -y
!apt-get install -y cmake build-essential m4 git wget
!apt-get install -y libfftw3-dev libgsl-dev

# å®‰è£… GPU æ”¯æŒç‰ˆ GROMACS
%cd /content
!wget ftp://ftp.gromacs.org/pub/gromacs/gromacs-2022.5.tar.gz
!tar xfz gromacs-2022.5.tar.gz
%cd gromacs-2022.5
!mkdir build
%cd build
!cmake .. -DGMX_GPU=CUDA -DGMX_BUILD_OWN_FFTW=ON -DCMAKE_INSTALL_PREFIX=/usr/local/gromacs
!make -j8
!make install

# åŠ è½½ GROMACS ç¯å¢ƒ
!source /usr/local/gromacs/bin/GMXRC
import os
os.environ['PATH'] = '/usr/local/gromacs/bin:' + os.environ['PATH']

#  æŒ‚è½½ Google Drive
from google.colab import drive
drive.mount('/content/drive')

import os

# ç¡®è®¤ Google Drive æŒ‚è½½è·¯å¾„æ˜¯å¦æ­£ç¡®
drive_path = "/content/drive/MyDrive/project/npt"
if not os.path.exists(drive_path):
    print(f"ç›®å½• {drive_path} ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ...")
    os.makedirs(drive_path)
else:
    print(f"ç›®å½• {drive_path} å­˜åœ¨ã€‚")

# æ£€æŸ¥æ˜¯å¦èƒ½å†™å…¥æ–‡ä»¶
test_file_path = os.path.join(drive_path, "test.txt")
try:
    with open(test_file_path, "w") as test_file:
        test_file.write("Test")
    print("å¯ä»¥æˆåŠŸå†™å…¥æ–‡ä»¶ï¼")
except Exception as e:
    print(f"å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")

# 2. æ–‡ä»¶å‡†å¤‡
# è¿›å…¥æ–‡ä»¶å¤¹ï¼ˆåœ¨è¯¥æ–‡ä»¶å¤¹å¯¼å…¥nvtè¾“å‡ºæ–‡ä»¶ï¼Œtopolæ–‡ä»¶ï¼Œä»¥åŠcharmmguiè¾“å‡ºçš„toppearæ–‡ä»¶å¤¹ï¼‰
%cd /content/drive/MyDrive/MD_project_10075026/step3_npt
import os

# æ£€æŸ¥ topol.top æ–‡ä»¶æ˜¯å¦å­˜åœ¨
topol_path = '/content/drive/MyDrive/MD_project/step3_npt/topol.top'
if os.path.exists(topol_path):
    print(f"æ‰¾åˆ° topol.top æ–‡ä»¶: {topol_path}")
else:
    print(f"æ²¡æœ‰æ‰¾åˆ° topol.top æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„æˆ–æ–‡ä»¶åã€‚")

# åˆ›å»º npt.mdp æ–‡ä»¶ï¼ˆæ­¤å¤„è¿è¡Œæ—¶é—´ä¸º1nsï¼‰
mdp_content = """
integrator              = md
nsteps                  = 1000000
dt                      = 0.002

nstxout-compressed      = 1000
continuation            = yes

constraint_algorithm    = lincs
constraints             = all-bonds
lincs_iter              = 1
lincs_order             = 4

cutoff-scheme           = Verlet
ns_type                 = grid
nstlist                 = 10
rcoulomb                = 1.0
rvdw                    = 1.0

tcoupl                  = V-rescale
tc-grps                 = System
tau_t                   = 0.1
ref_t                   = 310

pcoupl                  = Parrinello-Rahman
pcoupltype              = isotropic
tau_p                   = 2.0
ref_p                   = 1.0
compressibility         = 4.5e-5

pbc                     = xyz
gen_vel                 = no
"""

# ç¡®è®¤ç›®æ ‡ç›®å½•å­˜åœ¨
output_path = "/content/drive/MyDrive/project/npt/npt.mdp"
with open(output_path, "w") as file:
    file.write(mdp_content)

print(f"npt.mdp æ–‡ä»¶å·²æˆåŠŸåˆ›å»º: {output_path}")

# åˆ›å»º NPT tpr æ–‡ä»¶
!gmx grompp -f npt.mdp -c nvt.gro -r nvt.gro -t nvt.cpt -p topol.top -o npt.tpr

# æ£€æŸ¥ tpr æ˜¯å¦æˆåŠŸç”Ÿæˆ
!ls -lh npt.tpr

# 3. è¿è¡Œnptæ¨¡æ‹Ÿ
!gmx mdrun -deffnm npt -v

# æ¨¡æ‹Ÿè¿è¡Œæ—¶é—´è¿‡é•¿å¯ä¸­æ­¢åç»­è·‘
# æ¥ç»­æ¨¡æ‹Ÿ
# æŒ‚è½½ Google Drive
from google.colab import drive
drive.mount('/content/drive')

# å›åˆ° NPT æ¨¡æ‹Ÿä¿å­˜ç›®å½•
%cd /content/drive/MyDrive/project/npt/

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ checkpoint æ–‡ä»¶
!ls nvt.cpt

# æ¥ç»­å·¥ä½œ
!gmx mdrun -deffnm npt -cpi npt.cpt -v

# 4. æ¨¡æ‹Ÿå¯è§†åŒ–ï¼ˆæ ¹æ®è¾“å‡ºå›¾åƒï¼Œè‹¥ä½“ç³»å·²ç¨³å®šå¯æå‰ç»“æŸï¼‰
# é€šè¿‡è¾“å‡ºç»“æœåˆ¤æ–­ä½“ç³»ç¨³å®šæ€§ï¼ˆè¾“å…¥æƒ³æŸ¥çœ‹çš„é€‰é¡¹ç¼–å·ï¼Œæ¯ä¸ªç¼–å·éœ€æ¢è¡Œï¼Œç»“æŸè¾“å…¥0ï¼ŒTot-Driftåå¤§åˆ™éœ€å»¶é•¿æ—¶é—´ï¼‰
!gmx energy -f npt.edr

# å›¾åƒå¯è§†åŒ–
!gmx energy -f npt.edr -o temp.xvg
!gmx energy -f npt.edr -o pressure.xvg
!gmx energy -f npt.edr -o density.xvg

# è®¾ç½®å·¥ä½œç›®å½•ï¼ˆæ ¹æ®å®é™…æƒ…å†µï¼‰
work_dir = '/content/drive/MyDrive/project/npt/output'
os.chdir(work_dir)

# è¾“å‡ºå›¾ç‰‡
import matplotlib.pyplot as plt
import numpy as np

# å®šä¹‰ä¸€ä¸ªå‡½æ•°è¯»å– .xvg æ–‡ä»¶
def read_xvg(filename):
    x, y = [], []
    with open(filename, 'r') as f:
        for line in f:
            if line.startswith(('#', '@')):  # å¿½ç•¥æ³¨é‡Š
                continue
            cols = line.split()
            x.append(float(cols[0]))
            y.append(float(cols[1]))
    return np.array(x), np.array(y)

# è¯»å–æ¸©åº¦ã€å‹åŠ›ã€å¯†åº¦æ•°æ®
t, temp = read_xvg("temp.xvg")
t_p, pressure = read_xvg("pressure.xvg")
t_d, density = read_xvg("density.xvg")

# ç»˜åˆ¶å›¾åƒ
plt.figure(figsize=(20,5))

plt.subplot(1,3,1)
plt.plot(t, temp, color='tomato')
plt.title('Temperature (K)')
plt.xlabel('Time (ps)')
plt.ylabel('Temperature')
plt.savefig('npt_tem.tif', dpi=900)

plt.subplot(1,3,2)
plt.plot(t_p, pressure, color='royalblue')
plt.title('Pressure (bar)')
plt.xlabel('Time (ps)')
plt.ylabel('Pressure')
plt.savefig('npt_pre.tif', dpi=900)

plt.subplot(1,3,3)
plt.plot(t_d, density, color='seagreen')
plt.title('Density (kg/mÂ³)')
plt.xlabel('Time (ps)')
plt.ylabel('Density')
plt.savefig('npt_den.tif', dpi=900)

plt.tight_layout()
plt.show()

# âš¡ è‹¥æ¨¡æ‹Ÿç»“æŸåä½“ç³»ä»æœªå¹³è¡¡ï¼Œå¯é‡‡ç”¨å¦‚ä¸‹æ–¹å¼å»¶é•¿å¹³è¡¡æ—¶é—´
# ç”Ÿæˆæ–°çš„npt.mdpæ–‡ä»¶ï¼ˆä¿®æ”¹nstepså’Œnstxoutï¼‰
mdp_content = """
integrator              = md
nsteps                  = 1000000
dt                      = 0.002

nstxout-compressed      = 1000
continuation            = yes

constraint_algorithm    = lincs
constraints             = all-bonds
lincs_iter              = 1
lincs_order             = 4

cutoff-scheme           = Verlet
ns_type                 = grid
nstlist                 = 10
rcoulomb                = 1.0
rvdw                    = 1.0

tcoupl                  = V-rescale
tc-grps                 = System
tau_t                   = 0.1
ref_t                   = 310

pcoupl                  = Parrinello-Rahman
pcoupltype              = isotropic
tau_p                   = 2.0
ref_p                   = 1.0
compressibility         = 4.5e-5

pbc                     = xyz
gen_vel                 = no
"""

# ç¡®è®¤ç›®æ ‡ç›®å½•å­˜åœ¨
output_path = "/content/drive/MyDrive/project/npt/npt2.mdp"
with open(output_path, "w") as file:
    file.write(mdp_content)

print(f"npt2.mdp æ–‡ä»¶å·²æˆåŠŸåˆ›å»º: {output_path}")

# ç”Ÿæˆæ–°çš„ tprï¼Œå¸¦çŠ¶æ€æ¢å¤
!gmx grompp -f npt2.mdp -c npt.gro -t npt.cpt -p topol.top -o npt_long.tpr

# æ–­ç‚¹ç»­è·‘ï¼ˆæŒ‡å®š .tpr å’Œ checkpointï¼Œ-noappendä»£è¡¨ä»…æ”¯æŒå•æ¬¡ç»­è·‘ï¼Œæ¯æ¬¡ç»­è·‘ä»…ä»ç¬¬ä¸€ä¸ªæ–­ç‚¹å¼€å§‹ï¼‰
!gmx mdrun -s npt_long.tpr -deffnm npt2 -cpi npt.cpt -noappend -v

# å›åˆ°ä¸Šæ–¹å¯è§†åŒ–éªŒè¯éƒ¨åˆ†ç¡®è®¤ä½“ç³»çš„å¹³è¡¡æƒ…å†µ

# æ•°æ®å¤‡ä»½
#import shutil
import datetime
import os

# å½“å‰æ¨¡æ‹Ÿè¾“å‡ºæ–‡ä»¶å¤¹
src = "/content/drive/MyDrive/project/npt"

# å¤‡ä»½ç›®æ ‡è·¯å¾„ï¼ˆå«æ—¶é—´æˆ³ï¼‰
timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M")
backup_dir = "/content/drive/MyDrive/project/backups"
backup_zip = f"{backup_dir}/step3_npt_backup_{timestamp}.zip"

# ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
os.makedirs(backup_dir, exist_ok=True)

# æ‰§è¡Œå‹ç¼©å¤‡ä»½
shutil.make_archive(backup_zip.replace(".zip", ""), 'zip', src)

print(f"âœ… å¤‡ä»½å®Œæˆï¼\nğŸ“ è·¯å¾„: {backup_zip}")
